#!/bin/bash
set -e

SCRIPT_DIR="$( cd -P "$( dirname "${BASH_SOURCE[0]}" )" > /dev/null && pwd )/.."
APP_DIR="$SCRIPT_DIR/.."

if [[ "$SKIP_NGINX" == "true" ]]
then
  export NGINX_SOCKET_LOCATION=""
  $SCRIPT_DIR/app/startApp
else
  if [[ "$IS_HEROKU" == "" ]]
  then
    # not on heroku, so first we need to bootstrap the nginx buildpack
    BUILDPACK_DIR=/var/tmp/nginx-buildpack
    if [ ! -e $BUILDPACK_DIR/.git ]
    then
      echo "Installing nginx buildpack..."
      mkdir -p $BUILDPACK_DIR
      mkdir -p ${BUILDPACK_DIR}-env
      cd $BUILDPACK_DIR
      #git clone `fgrep nginx $APP_DIR/.buildpacks` .
    else
      echo -n "Updating nginx buildpack...  "
      cd $BUILDPACK_DIR
      #git pull
    fi
    export STATIC_ROOT="$APP_DIR/_public"
    ./bin/detect $APP_DIR && ./bin/compile $APP_DIR ${BUILDPACK_DIR}-cache ${BUILDPACK_DIR}-env && ./bin/release $APP_DIR
    cd $APP_DIR
  fi
  
  
  # this ensures we never wait more than 60 seconds before letting nginx bind the port;
  # we give a bit of slack for heroku startup overhead, nginx startup, etc
  
  rm -f /tmp/app-initialized
  rm -f /tmp/nginx-app-start
  rm -f /tmp/nginx-app-end
  
  (
    sleep 50
    if [ -e /tmp/nginx-app-start ] && [ ! -e /tmp/nginx-app-end ] && [ ! -e /tmp/app-initialized ]
    then
      echo "forcing 50s init..."
      touch /tmp/app-initialized
    fi
  ) &
  
  ./bin/start-nginx $SCRIPT_DIR/app/startApp
fi
