#!/bin/bash
set -ex
set -o pipefail

if [[ "$IS_HEROKU" != "" || "$CI" != "" ]]; then
  # use buildpacks if HEROKU
  # CI skipp installs and expect specs dependent on installs to be in backendIntegration
  exit 0
fi

platform='unknown'
unamestr=`uname`

if [[ "$unamestr" == 'Linux' ]]; then
  #http://sharp.dimens.io/en/stable/install/
  curl -s https://raw.githubusercontent.com/lovell/sharp/master/preinstall.sh | sudo bash -
  echo "installing libpoppler-cpp-dev..."
  cd /tmp/
  wget http://poppler.freedesktop.org/poppler-0.44.0.tar.xz
  tar -xf poppler-0.44.0.tar.xz
  cd poppler-0.44.0
  ./configure && make

  # apt-get install pkg-config libpoppler-cpp-dev

elif [[ "$unamestr" == 'Darwin' ]]; then
  #http://sharp.dimens.io/en/stable/install/
  if ! hash vips &> /dev/null || [[ $IS_HEROKU = 1 ]];then
    brew install homebrew/science/vips --with-imagemagick --with-webp
    brew install poppler
  fi
fi

exit 0
